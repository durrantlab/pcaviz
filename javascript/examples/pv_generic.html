<html>
    <head>
        <title>PV Generic Mode</title>
    </head>
    <body>
        <style>
            .mol-container {
                width: 60%;
                height: 400px;
                position: relative;
            }
        </style>
        <h1>PV Generic Mode</h1>
        <div id="viscontainer" class="mol-container"></div>

        <!-- Load the javascript files -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="http://biasmv.github.io/pv/js/pv.min.js"></script>
        <script src="BrowserSim.min.js"></script>
        <script>
            // Setup PV Generic Mode
            var pvViewer = pv.Viewer(
                document.getElementById('viscontainer'),
                {quality:'medium', width:'auto', height: 'auto', antialias: true, outline: true}
            );
            // Not entirely encapsulated, so put both the library and the viewer in a single object.
            var viewer = {viewer: pvViewer, library: pv};

            // Run sims in the browsers
            function makeBrowserSim(viewer, viewerType) {
                let browserSim = new BrowserSim({
                    viewer: viewer,
                    viewerType: viewerType,
                    visStyle: undefined,  // Not needed when in generic mode
                    durationInMilliseconds: 10000,
                    updateFreqInMilliseconds: 16.67,  // 60 fps
                    loop: true,
                    windowAverageSize: 1,
                    loadPDBTxt: (pdbTxt, viewer, browserSim) => viewer.library.io.pdb(pdbTxt),
                    updateAtomPositions: (newAtomCoors, model, viewer, browserSim) => {
                        let atomIdx = 0;
                        model.eachAtom((atom, idx) => {
                            let coors = newAtomCoors[atomIdx];
                            atom._bV = coors;
                            atomIdx++;
                        });
                    },
                    render: (model, viewer, browserSim) => {
                        viewer.viewer.clear();  // Because encapsulated
                        viewer.viewer.spheres("all", model);
                    },
                });

                browserSim.io.loadJSON("data.json", () => {
                    browserSim.player.start({
                        durationInMilliseconds: 10000,
                        updateFreqInMilliseconds: 16.67,  // 60 fps
                        loop: true,
                        windowAverageSize: 25
                    });

                    window.browserSim = browserSim;

                    setTimeout(() => {
                        browserSim.player.stop();
                        setTimeout(() => {
                            browserSim.player.toFrame(159);
                        }, 1000);
                    }, 5000);
                });
            }
            makeBrowserSim(viewer, 'GENERIC');
        </script>

    </body>
</html>